using System;
using System.Drawing;
using System.Globalization;
using BoletoNetCore.Util;
using Microsoft.VisualBasic;

namespace BoletoNetCore
{
    public class CodigoBarra
    {
        /// <summary>
        /// Representação numérica do Código de Barras, composto por 44 posições
        ///    01 a 03 - 3 - Identificação  do  Banco
        ///    04 a 04 - 1 - Código da Moeda
        ///    05 a 05 – 1 - Dígito verificador do Código de Barras
        ///    06 a 09 - 4 - Fator de vencimento
        ///    10 a 19 - 10 - Valor
        ///    20 a 44 – 25 - Campo Livre
        /// </summary>
        public string CodigoDeBarras
        {
            get
            {
                string codigoSemDv = string.Format("{0}{1}{2}{3}{4}",
                                                      CodigoBanco,
                                                      Moeda,
                                                      FatorVencimento,
                                                      ValorDocumento,
                                                      CampoLivre);
                return string.Format("{0}{1}{2}",
                                        codigoSemDv.Left(4),
                                        DigitoVerificador,
                                        codigoSemDv.Right(39));
            }
        }

        /// <summary>
        /// A linha digitável é composta por cinco campos:
        ///      1º campo
        ///          composto pelo código de Banco, código da moeda, as cinco primeiras posições do campo 
        ///          livre e o dígito verificador deste campo;
        ///      2º campo
        ///          composto pelas posições 6ª a 15ª do campo livre e o dígito verificador deste campo;
        ///      3º campo
        ///          composto pelas posições 16ª a 25ª do campo livre e o dígito verificador deste campo;
        ///      4º campo
        ///          composto pelo dígito verificador do código de barras, ou seja, a 5ª posição do código de 
        ///          barras;
        ///      5º campo
        ///          Composto pelo fator de vencimento com 4(quatro) caracteres e o valor do documento com 10(dez) caracteres, sem separadores e sem edição.
        /// </summary>
        public string LinhaDigitavel { get; set; } = String.Empty;

        /// <summary>
        /// Código do Banco (3 dígitos)
        /// </summary>
        public string CodigoBanco { get; set; } = String.Empty;

        /// <summary>
        /// Código da Moeda (9 = Real)
        /// </summary>
        public int Moeda { get; set; } = 9;

        /// <summary>
        /// Campo Livre - Implementado por cada banco.
        /// </summary>
        public string CampoLivre { get; set; } = String.Empty;

        public long FatorVencimento { get; set; } = 0;

        public string ValorDocumento { get; set; } = String.Empty;

        public string DigitoVerificador
        {
            get
            {
                string codigoSemDv = string.Format("{0}{1}{2}{3}{4}",
                                      CodigoBanco,
                                      Moeda,
                                      FatorVencimento,
                                      ValorDocumento,
                                      CampoLivre);

                // Calcula Dígito Verificador do Código de Barras
                // Array referencia com dígitos do código de barras.
                var a = Array.ConvertAll(codigoSemDv.ToCharArray(), c => (int)char.GetNumericValue(c));

                var sum = 0;
                for (var i = 0; i < a.Length; i++)
                {
                    // Indice para leitura reversa.
                    var ir = a.Length - 1 - i;

                    // seq: 2, 3, 4, 5, 6, 7, 8, 9, 2, 3, 4, 5 ...
                    var seq = i % 8 + 2;

                    // Soma produto de número sequencial e dígito do código de barras.
                    sum += seq * a[ir];
                }

                // Calcula-se o DAC.
                var resto = 11 - sum % 11;

                // Se o resultado desta, for igual a: 0, 1, 10 ou 11, considere DAC = 1.
                return resto <= 1 || resto > 9 ? "1" : resto.ToString();
            }
        }
    }
}